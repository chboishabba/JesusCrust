---
phase: 03-js-host-integration
type: execute
domain: runtime
---

<objective>
Validate and harden the JS host with deterministic replay, rollback/fallback handling, and a frozen host ↔ core API.

Purpose: Prove the host preserves batching semantics under replay and failure, and lock the API contract for Phase 4.
Output: Replay helpers with fingerprints, rollback/fallback guards, and a documented host-core API.
</objective>

<execution_context>
~/.codex/skills/get-shit-done/workflows/execute-phase.md
~/.codex/skills/get-shit-done/references/checkpoints.md
~/.codex/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-js-host-integration/03-CONTEXT.md
@.planning/phases/03-js-host-integration/03-01-PLAN.md
@.planning/phases/01-execution-harness/01-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/02-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/02-02-SUMMARY.md
@packages/js-host/src/dom.js
@packages/js-host/src/apply.js
@packages/js-host/src/runner.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic replay and fingerprinting</name>
  <files>packages/js-host/src/replay.js, packages/js-host/test/replay.test.js</files>
  <action>Add replay helpers that apply a PatchBatch to an initial DOM-equivalent snapshot and produce deterministic serialization plus a stable fingerprint (e.g., SHA-256 → u64). Tests must assert identical serialized output and fingerprint for repeated replays of the same batch and initial state.</action>
  <verify>npm test --prefix packages/js-host</verify>
  <done>Replay helper returns identical DOM/serializer output and fingerprint across runs; tests cover repeated replays with the same batch.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce rollback/fallback no-ops and mutation guard</name>
  <files>packages/js-host/src/runner.js, packages/js-host/test/rollback.test.js</files>
  <action>Ensure rollback/fallback batches (metaKind != commit) apply no ops and leave DOM unchanged. Add a host-level guard that throws if any DOM mutation occurs outside `commitBatch` (meta-test to catch leaks). Tests must confirm: rollback leaves DOM identical; fallback leaves DOM identical; mutation outside `commitBatch` is detected.</action>
  <verify>npm test --prefix packages/js-host</verify>
  <done>Rollback/fallback produce no DOM changes, mutation guard prevents out-of-bound writes, and tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Freeze and document host ↔ core API</name>
  <files>docs/host-core-api.md</files>
  <action>Document the Phase 3 host-core API: PatchBatch structure (EnsureNode, SetText, SetAttr, AppendChild, Remove), metaKind semantics, commit-only application, deterministic order requirement, serializer/fingerprint expectations, and replay/rollback behaviors. Include the mutation guard rule (no DOM writes outside apply) and one-commit-per-tick contract.</action>
  <verify>Doc renders and references the implemented behaviors and guards; cross-check against 03-01 implementation.</verify>
  <done>`docs/host-core-api.md` exists with the frozen API contract and matches the implemented host behavior.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `npm test --prefix packages/js-host` passes
</verification>

<success_criteria>

- Replay helper yields deterministic DOM state and fingerprint across runs
- Rollback/fallback batches perform no DOM mutation and are guarded
- Host mutation guard prevents writes outside commit
- Host-core API is documented and matches implementation
</success_criteria>

<output>
After completion, create `.planning/phases/03-js-host-integration/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Host Constraints + Debug Tooling Summary

**Substantive one-liner describing replay, guards, and API freeze.**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `packages/js-host/...` - Replay and guard logic
- `docs/host-core-api.md` - API contract

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3 complete, ready for Phase 4 planning.
</output>
