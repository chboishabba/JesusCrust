---
phase: 03-js-host-integration
type: execute
domain: runtime
---

<objective>
Build a deterministic JS host that applies core patch batches to a DOM-equivalent model and enforces one commit per tick.

Purpose: Prove the Rust/WASM core’s batching semantics survive contact with an imperative host.
Output: JS host package with patch applier, deterministic serializer, and commit-boundary runner with tests.
</objective>

<execution_context>
~/.codex/skills/get-shit-done/workflows/execute-phase.md
~/.codex/skills/get-shit-done/references/checkpoints.md
~/.codex/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-js-host-integration/03-CONTEXT.md
@.planning/phases/01-execution-harness/01-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/02-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/02-02-SUMMARY.md
@crates/core/src/patch.rs
@crates/core/src/effects.rs
@crates/core/src/scheduler.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deterministic DOM-equivalent host package</name>
  <files>packages/js-host/package.json, packages/js-host/src/dom.js, packages/js-host/src/apply.js, packages/js-host/test/apply.test.js</files>
  <action>Create `packages/js-host` (plain ESM) with a deterministic DOM-equivalent model (not the browser DOM), a NodeId→node registry, and a stable serializer. Implement patch application for core ops: EnsureNode, SetText, SetAttr, AppendChild, Remove. Keep ops synchronous and ordered; no coalescing. Add `npm test` using `node --test` to assert op ordering, idempotent EnsureNode, and deterministic serialization.</action>
  <verify>npm test --prefix packages/js-host</verify>
  <done>Package builds, tests pass, serializer output is stable across runs, and all core ops are applied in order with EnsureNode idempotency.</done>
</task>

<task type="auto">
  <name>Task 2: Add host runner enforcing commit boundary</name>
  <files>packages/js-host/src/runner.js, packages/js-host/test/runner.test.js</files>
  <action>Implement a host runner that receives a PatchBatch and applies it only via a single `commitBatch` entry point per tick. Reject or throw on any attempt to mutate outside `commitBatch`; enforce one commit per tick (no re-entry). Tests should prove: multiple batches per tick are rejected; mid-tick visibility doesn’t change until commit; normal commit applies the batch once.</action>
  <verify>npm test --prefix packages/js-host</verify>
  <done>Runner enforces single-commit-per-tick, blocks out-of-bound mutations, and all runner tests pass.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `npm test --prefix packages/js-host` passes
</verification>

<success_criteria>

- DOM-equivalent host applies EnsureNode/SetText/SetAttr/AppendChild/Remove deterministically
- Serializer output is stable and replay-friendly
- Runner enforces one commit per tick and prevents mid-tick mutations
</success_criteria>

<output>
After completion, create `.planning/phases/03-js-host-integration/03-01-SUMMARY.md`:

# Phase 3 Plan 1: JS Host Runner + Patch Applier Summary

**Substantive one-liner describing the shipped host + runner + tests.**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `packages/js-host/...` - Host package, runner, tests

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (constraints + debug tooling)
</output>
