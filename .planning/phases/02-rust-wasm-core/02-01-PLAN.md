---
phase: 02-rust-wasm-core
type: execute
domain: core-runtime
---

<objective>
Implement the Rust/WASM core foundation: crate scaffold, deterministic dependency graph, and core store/selector wiring.

Purpose: Establish the internal data model and dependency tracking needed for scheduling and patch generation.
Output: `crust_core` crate with graph + store + selector primitives and unit tests.
</objective>

<execution_context>
~/.codex/skills/get-shit-done/workflows/execute-phase.md
~/.codex/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-execution-harness/01-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/DISCOVERY.md
@crates/harness/src/runner.rs
@tests/js/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold crust_core crate and core types</name>
  <files>Cargo.toml, crates/core/Cargo.toml, crates/core/src/lib.rs, crates/core/src/types.rs</files>
  <action>Add a new workspace member `crates/core` with package name `crust_core`. Create `types.rs` with `NodeId(u64)` newtype and helper constructors. Export types from `lib.rs`. Keep the crate Rust-only (no wasm-bindgen/WIT dependencies yet) to preserve Phase 3 flexibility.</action>
  <verify>`cargo check -p crust_core` succeeds</verify>
  <done>Workspace builds with `crust_core` and `NodeId` is available from `crust_core`</done>
</task>

<task type="auto">
  <name>Task 2: Implement deterministic dependency graph</name>
  <files>crates/core/src/graph.rs, crates/core/src/lib.rs, crates/core/tests/graph.rs</files>
  <action>Implement a `DependencyGraph` that tracks edges between `NodeId`s with stable, deterministic traversal order. Use `BTreeMap`/`BTreeSet` (or equivalent ordering) for adjacency so iteration order is deterministic regardless of insertion. Provide APIs for `add_node`, `add_edge`, and `dependents_of`. Add tests that insert edges in different orders and assert traversal order is identical.</action>
  <verify>`cargo test -p crust_core --tests graph` passes</verify>
  <done>Graph traversal is deterministic and tests cover ordering stability</done>
</task>

<task type="auto">
  <name>Task 3: Implement store + selector dependency tracking</name>
  <files>crates/core/src/store.rs, crates/core/src/selector.rs, crates/core/src/lib.rs, crates/core/tests/store.rs</files>
  <action>Implement a minimal `Store` that maps `NodeId` â†’ value (`String` for now) and records reads into a `DependencyGraph` via a `SelectorContext`. Implement `Selector` as a wrapper that executes a closure with `SelectorContext` and registers dependencies on reads. Tests should validate: (1) reading a node registers a dependency edge, (2) repeated reads do not duplicate edges, (3) selectors can recompute after updates without mutating the committed graph ordering.</action>
  <verify>`cargo test -p crust_core --tests store` passes</verify>
  <done>Selectors track dependencies into the graph and tests confirm stable behavior</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check -p crust_core` passes
- [ ] `cargo test -p crust_core` passes
</verification>

<success_criteria>

- `crust_core` crate scaffolded in workspace
- Deterministic dependency graph implemented and tested
- Store/selector dependency tracking implemented and tested
</success_criteria>

<output>
After completion, create `.planning/phases/02-rust-wasm-core/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Core Store + Graph Summary

**Rust core crate defines NodeId, dependency graph, and selector-aware store primitives.**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ext` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-02-PLAN.md
</output>
