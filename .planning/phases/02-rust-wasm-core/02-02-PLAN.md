---
phase: 02-rust-wasm-core
type: execute
domain: core-runtime
---

<objective>
Implement patch ops, effect queue, and scheduler coalescing for the Rust/WASM core.

Purpose: Produce the core scheduling and patch batching logic that Phase 3's JS host will consume.
Output: Patch op types, scheduler with single-commit tick semantics, and integration tests.
</objective>

<execution_context>
~/.codex/skills/get-shit-done/workflows/execute-phase.md
~/.codex/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-execution-harness/01-01-SUMMARY.md
@.planning/phases/02-rust-wasm-core/DISCOVERY.md
@crates/harness/src/runner.rs
@tests/js/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define patch ops and effect queue types</name>
  <files>crates/core/src/patch.rs, crates/core/src/effects.rs, crates/core/src/lib.rs, crates/core/tests/patch.rs</files>
  <action>Create a `PatchOp` enum with minimal DOM-agnostic ops (e.g., `SetText`, `SetAttr`, `Insert`, `Remove`) using `NodeId` and owned strings. Add an `EffectQueue` that buffers patch ops during a tick and emits a batch on commit. Tests should validate ordering is preserved and batches clear after commit.</action>
  <verify>`cargo test -p crust_core --tests patch` passes</verify>
  <done>Patch ops and effect queue types are defined with deterministic ordering tests</done>
</task>

<task type="auto">
  <name>Task 2: Implement scheduler with single-commit tick semantics</name>
  <files>crates/core/src/scheduler.rs, crates/core/src/lib.rs, crates/core/tests/scheduler.rs</files>
  <action>Implement a `Scheduler` that exposes `begin_tick`, `enqueue_op`, and `commit_tick` to coalesce all ops into exactly one batch per tick. Prevent multiple commits per tick and reset state deterministically. Tests should assert: (1) multiple enqueues in a tick produce one batch, (2) commit without begin returns an error, (3) commit resets state for the next tick.</action>
  <verify>`cargo test -p crust_core --tests scheduler` passes</verify>
  <done>Scheduler enforces single commit per tick with deterministic behavior</done>
</task>

<task type="auto">
  <name>Task 3: Wire store updates to scheduler batches</name>
  <files>crates/core/src/engine.rs, crates/core/src/lib.rs, crates/core/tests/engine.rs</files>
  <action>Create a lightweight `Engine` that owns `Store` + `Scheduler`, exposes `begin_tick`, `set_value`, and `commit` which returns a patch batch. For now, generate a `SetText` patch op for `set_value` calls to mirror the harness's effect log. Tests should assert one commit per tick and deterministic batch ordering.</action>
  <verify>`cargo test -p crust_core --tests engine` passes</verify>
  <done>Engine produces deterministic patch batches per tick via the scheduler</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo test -p crust_core` passes
</verification>

<success_criteria>

- Patch ops and effect queue types are defined and tested
- Scheduler enforces one commit per tick
- Engine integrates store and scheduler to produce patch batches
</success_criteria>

<output>
After completion, create `.planning/phases/02-rust-wasm-core/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Scheduler + Patch Ops Summary

**Core scheduler emits deterministic patch batches aligned with single-commit tick semantics.**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ext` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for next phase
</output>
