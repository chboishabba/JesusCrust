---
phase: 06-browser-rollout
type: instrumentation
domain: telemetry
---

<objective>
Deliver the Servo-side telemetry hooks and UI instrumentation that prove selector work is the per-tick bottleneck while keeping the Phase-5 guardrails unchanged. The work must always be feature-flagged off by default so that Servo’s existing conformance gate, deterministic fingerprints, and `npm run conformance` behavior stay stable until we intentionally flip the flag after validation.
</objective>

<context>
@.planning/phases/06-browser-rollout/06-01-PLAN.md
@docs/phase6_browser_ui.md
@docs/servo-selector-invalidation-pr.md
@docs/phase6_pr_boundaries.md
</context>

<tasks>

<task type="research">
  <name>Task 1: Instrument Servo with recorder hooks + selector counters</name>
  <files>crates/core, crates/harness, docs/phase6_browser_ui.md</files>
  <action>Identify Servo codepaths that are executing selector invalidation, layout, and renderer work per tick, then wire lightweight telemetry recorder hooks that sample durations and counter deltas. Every hook must check the Phase-6 feature flag and return immediately when telemetry is disabled so no extra work or state leaks into the default build. Capture selector metrics required by `docs/phase6_browser_ui.md` (e.g., `selector_match_ms`, `elements_invalidated`, `selectors_evaluated`) and ensure the recorder exposes the per-tick fingerprint/fallback metadata the host UI expects.</action>
  <verify>Feature flag guards every telemetry call, selectors counter increments map to documented fields, and a dummy tick still compiles with telemetry tooling disabled.</verify>
  <done>Recorder hooks live in Servo’s selector/layout/render stack, metrics fire behind the flag, and telemetry export structs mirror the Phase-6 schema.</done>
</task>

<task type="development">
  <name>Task 2: Hook counters into Phase-6 UI graphs</name>
  <files>prototypes/browser-extension/ui.js prototypes/browser-extension/telemetry.js docs/phase6_browser_ui.md</files>
  <action>Extend the telemetry snapshot surface so UI code plots the per-tick work stack (script/style/layout/render), selector breakdown, guardrail health (fallback/rollback rates), and fingerprint stability over time. This requires mapping the new Servo counters to graph inputs, adding state to `ui.js` to compute rolling averages/P95s, and ensuring tagging/labels mention whether the telemetry stream is live or in fallback mode.</action>
  <verify>UI graphs now draw the new counters, aggregate values match recorded telemetry (e.g., tick durations sum to total_ms) and guardrail/fingerprint status updates as ticks roll in.</verify>
  <done>The Phase-6 popup displays the requested dashboards and the telemetry snapshot includes the new selector-related fields referenced by Servo instrumentation.</done>
</task>

<task type="coordination">
  <name>Task 3: Ship selector invalidation PR with telemetry backing</name>
  <files>docs/servo-selector-invalidation-pr.md docs/phase6_browser_ui.md</files>
  <action>Prep the Servo selector invalidation PR by outlining the telemetry insights that prove selectors dominate each tick before optimizing. Ensure PR notes mention the feature flag, how the telemetry instrumentation is toggled, and that `npm run conformance` plus deterministic fingerprint outputs remain unchanged; include guardrail health/fingerprint stability graphs as part of the telemetry narrative.</action>
  <verify>Selector invalidation PR references the new telemetry hooks, mentions the Phase-6 UI graphs, and explicitly states that no `npm run conformance` regression nor fingerprint churn occurs.</verify>
  <done>PR description ready with telemetry screenshots/narrative, selectors work gated by the feature flag, and reviewers can see the verification steps to confirm telemetry dominance.</done>
</task>

</tasks>

<assumptions>
- Servo already exposes the necessary entry points for telemetry counters to be instrumented without touching SpiderMonkey internals (we can reuse the existing `crates/core` tick tracking).
- The Phase-6 UI and telemetry helper are located under `prototypes/browser-extension/` and can read new fields without build changes.
- No additional `npm run conformance` flags or scripts are required beyond verifying existing command remains green.
</assumptions>

<verification>
- [ ] Phase-6 feature flag disables new telemetry in default builds.
- [ ] UI graphs now plot selector breakdown, guardrail health, fingerprint stability, and per-tick work stack.
- [ ] `npm run conformance` still passes with Servo instrumentation enabled.
- [ ] Selector invalidation PR references the telemetry story and is ready for submission.
</verification>

<success_criteria>
- Servo emits the documented telemetry schema per tick when the Phase-6 flag is flipped on.
- Phase-6 UI graphs show selectors dominating ticks before any selector-focused PR merges.
- Selector invalidation PR ships once telemetry proves the selector work dominates the tick while deterministic fingerprints and conformance remain untouched.
</success_criteria>

<output>
After execution, capture telemetry samples (JSON or test vectors) in `.planning/phases/06-browser-rollout/06-02-SUMMARY.md` so future reviewers see selector-dominant ticks before optimization.
</output>
