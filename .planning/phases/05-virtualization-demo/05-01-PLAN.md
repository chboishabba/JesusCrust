---
phase: 05-virtualization-demo
type: demonstration
domain: integration
---

<objective>
Demonstrate how the drop-in adapter can host a lightweight virtualization engine that keeps only the visible rows in the DOM-equivalent layer while keeping the D0 invariants intact.
Purpose: Prove that virtualization strategies can be expressed as renderer workloads on top of the adapter without leaking uncommitted state, while the host still applies a single deterministic batch per tick.
Output: A virtualization helper module, a runnable script that simulates a large scrolling list, and notes about how virtualization fits inside the drop-in contract.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/dropin_adapter_contract.md
@docs/dropin_overview.md
@prototypes/dropin/adapter.js
@prototypes/dropin/preact-renderer.js
@prototypes/dropin/preact-example.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create a virtualization helper</name>
  <files>prototypes/dropin/virtualizer.js</files>
  <action>Implement a helper that takes a large dataset and a scroll window (offset + limit) and produces a Preact tree that only contains the rows currently visible. Ensure each row uses a stable key derived from its data so virtualization can reuse NodeIds across window shifts.</action>
  <verify>`node prototypes/dropin/virtualization-test.js` consumes the helper to render two different windows and checks NodeId reuse + limited serialized payload size.</verify>
  <done>Virtualizer helper outputs conditional children keyed by row identity.</done>
</task>

<task type="auto">
  <name>Task 2: Demonstrate virtualization with the drop-in host</name>
  <files>prototypes/dropin/virtualization-test.js</files>
  <action>Write a script that mounts the virtualization helper into the adapter, commits multiple window shifts, logs the serialized DOM per tick, and asserts the serialized node count never exceeds the visible window. Use `host.getDiagnostics()` to show commits follow virtualization windows.</action>
  <verify>`node prototypes/dropin/virtualization-test.js` runs, prints snapshots for 2-3 windows, and confirms the adapter only commits rows in view.</verify>
  <done>Virtualization scenario shows deterministic commits with only the visible subset volunteered to the host.</done>
</task>

<task type="auto">
  <name>Task 3: Document virtualization in the drop-in overview</name>
  <files>docs/dropin_overview.md</files>
  <action>Add a short section that explains where virtualization fits into the adapter story, mention the new scripts, and capture the expectation that virtualization is just another renderer workload that respects the single-commit/invariants contract.</action>
  <verify>`git diff docs/dropin_overview.md` shows the virtualization paragraph.</verify>
  <done>Overview calls out virtualization as an example consumer of the contract.
</task>

</tasks>

<verification>
Before marking this plan done:
- [ ] `node prototypes/dropin/virtualization-test.js` runs cleanly
- [ ] Serialized DOM snapshots contain only visible rows for each window shift
</verification>

<success_criteria>
- Virtualization helper maps windows to deterministic Preact trees with stable keys
- Runnable script proves the drop-in host serializes at most the visible rows per tick
- Docs mention virtualization as a scenario that the adapter already supports
</success_criteria>

<output>
After success, consider writing `.planning/phases/05-virtualization-demo/05-01-SUMMARY.md` capturing the demonstration learnings.
</output>
